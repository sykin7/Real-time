<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secure Chat App</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #008069;
            --bg-color: #e5ddd5;
            --white: #ffffff;
            --my-msg-bg: #dcf8c6;
            --other-msg-bg: #ffffff;
            --shadow: 0 1px 3px rgba(0,0,0,0.12);
        }
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #d1d7db; height: 100vh; display: flex; justify-content: center; overflow: hidden; }
        
        .app-container { width: 100%; max-width: 500px; height: 100%; background: var(--bg-color); position: relative; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* Toast Notification */
        #toast-container { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: #333; color: #fff; padding: 12px 20px; border-radius: 8px; font-size: 14px; opacity: 0; transform: translateY(-20px); transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15); text-align: center; pointer-events: auto; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: #d32f2f; }
        .toast.success { background: #43a047; }

        /* Auth Screen */
        #auth-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 30px; }
        .auth-card { background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; text-align: center; }
        .auth-card h2 { color: var(--primary-color); margin-bottom: 25px; font-weight: 600; }
        .input-group { margin-bottom: 15px; position: relative; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }
        .custom-input { width: 100%; padding: 12px 15px 12px 40px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; transition: border 0.3s; }
        .custom-input:focus { border-color: var(--primary-color); }
        .primary-btn { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: opacity 0.2s; }
        .primary-btn:active { opacity: 0.8; }
        .primary-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Chat Screen */
        #chat-screen { display: flex; flex-direction: column; height: 100%; width: 100%; }
        
        header { background: var(--primary-color); padding: 10px 15px; color: white; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .user-avatar { width: 35px; height: 35px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0; }
        .header-info { flex-grow: 1; overflow: hidden; }
        .current-user { font-size: 12px; opacity: 0.9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .target-input { background: rgba(255,255,255,0.15); border: none; color: white; padding: 6px 12px; border-radius: 15px; width: 100%; font-size: 14px; margin-top: 2px; }
        .target-input::placeholder { color: rgba(255,255,255,0.7); }
        .logout-btn { color: white; background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; opacity: 0.8; }

        #chat-box { flex-grow: 1; overflow-y: auto; padding: 15px; background-image: radial-gradient(#d4d4d4 1px, transparent 1px); background-size: 20px 20px; -webkit-overflow-scrolling: touch; }
        
        .msg-row { display: flex; margin-bottom: 12px; animation: slideIn 0.2s ease; }
        .msg-bubble { max-width: 75%; padding: 8px 12px; border-radius: 7.5px; position: relative; font-size: 15px; line-height: 1.4; box-shadow: var(--shadow); word-wrap: break-word; }
        
        .other-msg { justify-content: flex-start; }
        .other-msg .msg-bubble { background: var(--white); border-top-left-radius: 0; }
        
        .my-msg { justify-content: flex-end; }
        .my-msg .msg-bubble { background: var(--my-msg-bg); border-top-right-radius: 0; }
        
        .meta-info { display: flex; justify-content: flex-end; align-items: center; gap: 4px; margin-top: 4px; }
        .time-stamp { font-size: 10px; color: #999; }
        .status-icon { font-size: 10px; color: #4fb6ec; }

        .input-area { background: #f0f0f0; padding: 8px 10px; display: flex; align-items: center; gap: 8px; border-top: 1px solid #ddd; }
        #message-input { flex-grow: 1; padding: 10px 15px; border: none; border-radius: 20px; font-size: 15px; background: white; max-height: 100px; }
        .send-btn-circle { width: 40px; height: 40px; background: var(--primary-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; border: none; cursor: pointer; transition: transform 0.1s; flex-shrink: 0; }
        .send-btn-circle:active { transform: scale(0.95); }

        .hidden { display: none !important; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="toast-container"></div>

        <div id="auth-screen">
            <div class="auth-card">
                <h2><i class="fas fa-comments"></i> Chat Pro</h2>
                <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="email" id="email" class="custom-input" placeholder="邮箱地址">
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" class="custom-input" placeholder="密码">
                </div>
                <button onclick="handleLogin()" id="login-btn" class="primary-btn">登录 / 注册</button>
            </div>
        </div>

        <div id="chat-screen" class="hidden">
            <header>
                <div class="user-avatar"><i class="fas fa-user"></i></div>
                <div class="header-info">
                    <div class="current-user" id="my-display-email">Loading...</div>
                    <input type="text" id="target-email" class="target-input" placeholder="输入对方邮箱..." onchange="reloadChat()">
                </div>
                <button class="logout-btn" onclick="signOut()"><i class="fas fa-sign-out-alt"></i></button>
            </header>

            <div id="chat-box"></div>

            <div class="input-area">
                <input type="text" id="message-input" placeholder="发消息..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="send-btn-circle" onclick="sendMessage()" id="send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'PLACEHOLDER_SUPABASE_URL'
        const SUPABASE_KEY = 'PLACEHOLDER_SUPABASE_KEY'

        const { createClient } = supabase
        const client = createClient(SUPABASE_URL, SUPABASE_KEY)
        let myEmail = "";
        let allMessagesCache = [];

        // Check login status on load
        checkSession();

        async function checkSession() {
            const { data } = await client.auth.getSession();
            if (data.session) {
                myEmail = data.session.user.email;
                enterChatMode();
            }
        }

        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const btn = document.getElementById('login-btn');
            
            if (!email || !password) return showToast("请填写完整的邮箱和密码", "error");
            
            btn.innerText = "处理中...";
            btn.disabled = true;

            let { data, error } = await client.auth.signInWithPassword({ email, password });
            
            if (error) {
                const signUp = await client.auth.signUp({ email, password });
                if (signUp.error) {
                    showToast(signUp.error.message, "error");
                    btn.innerText = "登录 / 注册";
                    btn.disabled = false;
                    return;
                }
                data = signUp.data;
                showToast("新账号注册成功！", "success");
            }

            if (data.user) {
                myEmail = data.user.email;
                enterChatMode();
            }
        }

        function enterChatMode() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('chat-screen').classList.remove('hidden');
            document.getElementById('my-display-email').innerText = myEmail;
            
            const lastContact = localStorage.getItem('last_contact_' + myEmail);
            if (lastContact) {
                document.getElementById('target-email').value = lastContact;
            }
            
            startChatSystem();
        }

        async function startChatSystem() {
            const { data, error } = await client
                .from('messages')
                .select('*')
                .order('created_at', { ascending: true });
            
            if (error) {
                showToast("无法加载消息: " + error.message, "error");
                return;
            }

            if (data) {
                allMessagesCache = data;
                renderMessages(true);
            }

            client.channel('chat_room')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                    allMessagesCache.push(payload.new);
                    renderMessages(false);
                })
                .subscribe();
        }

        function renderMessages(forceScroll = false) {
            const chatBox = document.getElementById('chat-box');
            const targetEmail = document.getElementById('target-email').value.trim();
            
            // Smart scroll detection
            const isNearBottom = chatBox.scrollHeight - chatBox.scrollTop - chatBox.clientHeight < 100;

            chatBox.innerHTML = ''; 

            const filteredMsgs = allMessagesCache.filter(msg => {
                return (msg.sender_email === myEmail && msg.receiver_email === targetEmail) ||
                       (msg.sender_email === targetEmail && msg.receiver_email === myEmail);
            });

            if (filteredMsgs.length === 0 && targetEmail) {
                chatBox.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px; font-size:12px;">暂无消息，开始聊天吧</div>';
            }

            filteredMsgs.forEach(msg => {
                const isMe = msg.sender_email === myEmail;
                const div = document.createElement('div');
                div.className = 'msg-row ' + (isMe ? 'my-msg' : 'other-msg');
                
                const date = new Date(msg.created_at);
                const timeStr = date.getHours().toString().padStart(2, '0') + ':' + date.getMinutes().toString().padStart(2, '0');

                // Security Fix: Use textContent for message body to prevent XSS
                const bubble = document.createElement('div');
                bubble.className = 'msg-bubble';
                
                const textSpan = document.createElement('span');
                textSpan.textContent = msg.content;
                
                const metaDiv = document.createElement('div');
                metaDiv.className = 'meta-info';
                metaDiv.innerHTML = `<span class="time-stamp">${timeStr}</span>`;
                if(isMe) metaDiv.innerHTML += `<i class="fas fa-check status-icon"></i>`;

                bubble.appendChild(textSpan);
                bubble.appendChild(metaDiv);
                div.appendChild(bubble);
                chatBox.appendChild(div);
            });

            if (forceScroll || isNearBottom) {
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        function reloadChat() {
            const target = document.getElementById('target-email').value.trim();
            if(target) {
                localStorage.setItem('last_contact_' + myEmail, target);
            }
            renderMessages(true);
        }

        async function sendMessage() {
            const target = document.getElementById('target-email').value.trim();
            const input = document.getElementById('message-input');
            const text = input.value.trim(); // Trim whitespace
            const btn = document.getElementById('send-btn');

            if (!target) return showToast("请先在顶部输入对方邮箱", "error");
            if (!text) return;

            // Optimistic UI: Clear input immediately
            input.value = '';
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
            
            const { error } = await client.from('messages').insert({
                content: text,
                sender_email: myEmail,
                receiver_email: target
            });

            if (error) {
                showToast("发送失败", "error");
                input.value = text; // Restore text if failed
            } else {
                localStorage.setItem('last_contact_' + myEmail, target);
            }
            btn.innerHTML = '<i class="fas fa-paper-plane"></i>';
        }

        async function signOut() {
            await client.auth.signOut();
            localStorage.removeItem('last_contact_' + myEmail); // Clear cache
            location.reload();
        }

        // Custom Toast Notification Function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<i class="fas ${type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle'}"></i> ${message}`;
            
            container.appendChild(toast);
            
            // Animation
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
